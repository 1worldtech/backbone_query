((function(){var a,b,c,d,e,f,g,h,i,j,k=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};b=function(a){var b;return b=_.rest(a),_.filter(_.uniq(a[0]),function(a){return _.every(b,function(b){return _.indexOf(b,a)>=0})})},g=function(a){var b,c,d,e,f,g;g=[];for(b in a){d=a[b],c={key:b};if(_.isRegExp(d))c.type="$regex",c.value=d;else if(_(d).isObject())for(e in d)f=d[e],j(e,f)&&(c.type=e,c.value=f);else c.type="$equal",c.value=d;g.push(c)}return g},j=function(a,b){switch(a){case"$in":case"$nin":case"$all":case"$any":return _(b).isArray();case"$size":return _(b).isNumber();case"$regex":return _(b).isRegExp();case"$like":return _(b).isString();case"$between":return _(b).isArray()&&b.length===2;case"$cb":return _(b).isFunction();default:return!0}},d=function(a,b,c){var d;return d=g(b),a.filter(function(a){var b,e,f,g;for(f=0,g=d.length;f<g;f++){e=d[f],b=a.get(e.key);if(c===function(){var c;switch(e.type){case"$equal":return b===e.value;case"$contains":return _(b).isArray()?(c=e.value,k.call(b,c)>=0):!1;case"$ne":return b!==e.value;case"$lt":return b<e.value;case"$gt":return b>e.value;case"$lte":return b<=e.value;case"$gte":return b>=e.value;case"$between":return e.value[0]<b&&b<e.value[1];case"$in":return k.call(e.value,b)>=0;case"$nin":return k.call(e.value,b)<0;case"$all":if(_(b).isArray())return _(a.get(e.key)).all(function(a){return k.call(e.value,a)>=0});break;case"$any":if(_(b).isArray())return _(a.get(e.key)).any(function(a){return k.call(e.value,a)>=0});break;case"$size":return b.length===e.value;case"$exists":case"$has":return a.has(e.key)===e.value;case"$like":return b.indexOf(e.value)!==-1;case"$regex":return e.value.test(b);case"$cb":return e.value(b)}}())return c}return!c})},a=function(a,b){return d(a,b,!1)},e=function(a,b){return d(a,b,!0)},h={$and:function(b,c){return a(b,c)},$or:function(a,b){return e(a,b)},$nor:function(a,b){return _.difference(a.models,e(a,b))},$not:function(b,c){return _.difference(b.models,a(b,c))}},c=function(a,c){var d,e,f;d=_(c).chain().keys().intersection(["$or","$and","$nor","$not"]).value();switch(d.length){case 0:return h.$and(a,c);case 1:return f=d[0],h[f](a,c[f]);default:return e=function(){var b,e,g;g=[];for(b=0,e=d.length;b<e;b++)f=d[b],g.push(h[f](a,c[f]));return g}(),b(e)}},i=function(a,b){return _(b.sortBy).isString()?a=_(a).sortBy(function(a){return a.get(b.sortBy)}):_(b.sortBy).isFunction()&&(a=_(a).sortBy(b.sortBy)),b.order==="desc"&&(a=a.reverse()),a},f=function(a,b){var c,d;return b.offset?d=b.offset:b.page?d=(b.page-1)*b.limit:d=0,c=d+b.limit,a.slice(d,c)},Backbone.QueryCollection=Backbone.Collection.extend({query:function(a,b){var d;return b==null&&(b=!1),d=c(this,a),_(b).isObject()&&(b.sortBy&&(d=i(d,b)),b.limit&&(d=f(d,b))),d}})})).call(this)