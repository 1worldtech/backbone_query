var Backbone,detect,filter,getCache,getModels,getSortedModels,getType,iterator,makeObj,pageModels,parseQuery,performQuery,processQuery,reject,sortModels,testModelAttribute,testQueryValue,_,__slice=[].slice,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};filter=function(a,b){var c,d,e,f;f=[];for(d=0,e=a.length;d<e;d++)c=a[d],b(c)&&f.push(c);return f},reject=function(a,b){var c,d,e,f;f=[];for(d=0,e=a.length;d<e;d++)c=a[d],b(c)||f.push(c);return f},detect=function(a,b){var c,d,e;for(d=0,e=a.length;d<e;d++){c=a[d];if(b(c))return!0}return!1},makeObj=function(){var a,b,c,d,e;a=1<=arguments.length?__slice.call(arguments,0):[],d={},b=d;while(a.length)c=a.shift(),e=a.length===1?a.shift():{},b=b[c]=e;return d},getType=function(a){return _.isRegExp(a)?"$regex":_.isDate(a)?"$date":_.isObject(a)&&!_.isArray(a)?"object":_.isArray(a)?"array":_.isString(a)?"string":_.isNumber(a)?"number":_.isBoolean(a)?"boolean":_.isFunction(a)?"function":!1},parseQuery=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;_.isArray(a)?g=a:g=function(){var c;c=[];for(b in a){if(!__hasProp.call(a,b))continue;j=a[b],c.push(makeObj(b,j))}return c}(),n=[];for(l=0,m=g.length;l<m;l++){f=g[l];for(b in f){if(!__hasProp.call(f,b))continue;h=f[b],c={key:b},d=getType(h);switch(d){case"$regex":case"$date":c.type=d,c.value=h;break;case"object":if(b==="$and"||b==="$or"||b==="$nor"||b==="$not")c.value=h,c.type=b,c.key=null;else for(i in h){k=h[i];if(testQueryValue(i,k)){c.type=i;switch(i){case"$elemMatch":case"$relationMatch":c.value=parseQuery(k);break;case"$computed":e=makeObj(b,k),c.value=parseQuery(e);break;default:c.value=k}}}break;default:c.type="$equal",c.value=h}c.type==="$equal"&&(d==="object"||d==="array")&&(c.type="$oEqual")}n.push(c)}return n},testQueryValue=function(a,b){switch(a){case"$in":case"$nin":case"$all":case"$any":return _(b).isArray();case"$size":return _(b).isNumber();case"$regex":return _(b).isRegExp();case"$like":case"$likeI":return _(b).isString();case"$between":return _(b).isArray()&&b.length===2;case"$cb":return _(b).isFunction();default:return!0}},testModelAttribute=function(a,b){switch(a){case"$like":case"$likeI":case"$regex":return _(b).isString();case"$contains":case"$all":case"$any":case"$elemMatch":return _(b).isArray();case"$size":return _(b).isArray()||_(b).isString();case"$in":case"$nin":return b!=null;case"$relationMatch":return b!=null&&b.models;default:return!0}},performQuery=function(a,b,c,d,e){switch(a){case"$equal":return _(c).isArray()?__indexOf.call(c,b)>=0:c===b;case"$oEqual":return _(c).isEqual(b);case"$contains":return __indexOf.call(c,b)>=0;case"$ne":return c!==b;case"$lt":return c<b;case"$gt":return c>b;case"$lte":return c<=b;case"$gte":return c>=b;case"$between":return b[0]<c&&c<b[1];case"$in":return __indexOf.call(b,c)>=0;case"$nin":return __indexOf.call(b,c)<0;case"$all":return _(b).all(function(a){return __indexOf.call(c,a)>=0});case"$any":return _(c).any(function(a){return __indexOf.call(b,a)>=0});case"$size":return c.length===b;case"$exists":case"$has":return c!=null===b;case"$like":return c.indexOf(b)!==-1;case"$likeI":return c.toLowerCase().indexOf(b.toLowerCase())!==-1;case"$regex":return b.test(c);case"$cb":return b.call(d,c);case"$elemMatch":return iterator(c,b,!1,detect,"elemMatch");case"$relationMatch":return iterator(c.models,b,!1,detect,"relationMatch");case"$computed":return iterator([d],b,!1,detect,"computed");case"$and":case"$or":case"$nor":case"$not":return processQuery[a]([d],b).length===1;default:return!1}},iterator=function(a,b,c,d,e){var f;return e==null&&(e=!1),f=e?b:parseQuery(b),d(a,function(a){var b,d,g,h,i;for(h=0,i=f.length;h<i;h++){d=f[h],b=function(){switch(e){case"elemMatch":return a[d.key];case"computed":return a[d.key]();default:return a.get(d.key)}}(),g=testModelAttribute(d.type,b),g&&(g=performQuery(d.type,d.value,b,a,d.key));if(c===g)return c}return!c})},processQuery={$and:function(a,b){return iterator(a,b,!1,filter)},$or:function(a,b){return iterator(a,b,!0,filter)},$nor:function(a,b){return iterator(a,b,!0,reject)},$not:function(a,b){return iterator(a,b,!1,reject)}},getCache=function(a,b,c){var d,e,f,g;return f=JSON.stringify(b),d=(g=a._queryCache)!=null?g:a._queryCache={},e=d[f],e||(e=getSortedModels(a,b,c),d[f]=e),e},getModels=function(a,b){var c,d,e,f,g,h;f=_(b).keys(),c=["$and","$not","$or","$nor"],d=_.intersection(c,f);if(d.length===0)return processQuery.$and(a.models,b);if(d.length!==f.length){__indexOf.call(d,"$and")<0&&(b.$and={},d.unshift("$and"));for(e in b){if(!__hasProp.call(b,e))continue;h=b[e];if(__indexOf.call(c,e)<0)b.$and[e]=h,delete b[e];else continue}}return g=function(a,c){return processQuery[c](a,b[c])},_.reduce(d,g,a.models)},getSortedModels=function(a,b,c){var d;return d=getModels(a,b),c.sortBy&&(d=sortModels(d,c)),d},sortModels=function(a,b){return _(b.sortBy).isString()?a=_(a).sortBy(function(a){return a.get(b.sortBy)}):_(b.sortBy).isFunction()&&(a=_(a).sortBy(b.sortBy)),b.order==="desc"&&(a=a.reverse()),a},pageModels=function(a,b){var c,d,e,f;return b.offset?e=b.offset:b.page?e=(b.page-1)*b.limit:e=0,c=e+b.limit,d=a.slice(e,c),b.pager&&_.isFunction(b.pager)&&(f=Math.ceil(a.length/b.limit),b.pager(f,d)),d},typeof require!="undefined"&&(_=require("underscore"),Backbone=require("backbone")),Backbone.QueryCollection=Backbone.Collection.extend({query:function(a,b){var c;return b==null&&(b={}),b.cache?c=getCache(this,a,b):c=getSortedModels(this,a,b),b.limit&&(c=pageModels(c,b)),c},findOne:function(a){return this.query(a)[0]},whereBy:function(a,b){return b==null&&(b={}),new this.constructor(this.query(a,b))},resetQueryCache:function(){return this._queryCache={}}}),typeof exports!="undefined"&&(exports.QueryCollection=Backbone.QueryCollection)